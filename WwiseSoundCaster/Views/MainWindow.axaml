<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:WwiseSoundCaster.ViewModels"
        xmlns:models="using:WwiseSoundCaster.Models"
        xmlns:beh="using:WwiseSoundCaster.Behaviors"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="1280" d:DesignHeight="720"
        x:Class="WwiseSoundCaster.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Title="Wwise SoundCaster"
        Width="1280" Height="720"
        MinWidth="900" MinHeight="500"
        Background="#1E1E1E"
        Icon="/Assets/soundboard.ico">

    <!-- ═══════════════════════════════════════════════════════════
         RESOURCES
         ═══════════════════════════════════════════════════════════ -->
    <Window.Resources>
        <!-- EventViewModel DataTemplate for Related Events blocks -->
        <DataTemplate x:Key="EventBlockTemplate"
                      x:DataType="vm:EventViewModel">
            <Border Background="#333337"
                    CornerRadius="5"
                    Padding="10,8"
                    Margin="0,0,8,8">
                <Grid ColumnDefinitions="*,Auto">
                    <!-- Event name -->
                    <TextBlock Grid.Column="0"
                               Text="{Binding Name}"
                               Foreground="#D4D4D4"
                               FontSize="13"
                               VerticalAlignment="Center"
                               TextTrimming="CharacterEllipsis"/>
                    <!-- Play button -->
                    <Button Grid.Column="1"
                            Command="{Binding PlayCommand}"
                            ToolTip.Tip="Play this event"
                            Background="#3E3E42"
                            Foreground="#D4D4D4"
                            Padding="8,4"
                            CornerRadius="4"
                            FontSize="12"
                            Margin="8,0,0,0">
                        ▶
                    </Button>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- SwitchOptionModel DataTemplate for ComboBox items -->
        <DataTemplate x:Key="SwitchOptionTemplate"
                      x:DataType="models:SwitchOptionModel">
            <TextBlock Text="{Binding Name}"
                       Foreground="#DCDCDC"
                       FontSize="12"/>
        </DataTemplate>
    </Window.Resources>

    <!-- Design-time: x:DataType above is sufficient for compiled bindings.
         No Design.DataContext instantiation because the ViewModel requires
         DI constructor parameters. -->

    <!-- ═══════════════════════════════════════════════════════════
         ROOT LAYOUT – Two-column Grid with GridSplitter
         Col 0 : Left Event Browser   (~30 %)
         Col 1 : GridSplitter
         Col 2 : Right Control Panel   (~70 %)
         ═══════════════════════════════════════════════════════════ -->
    <Grid ColumnDefinitions="1*,4,3*">

        <!-- ─────────────────────────────────────────────────────
             LEFT PANEL – Event Browser
             ───────────────────────────────────────────────────── -->
        <Border Grid.Column="0"
                Background="#252526"
                CornerRadius="0"
                Margin="0">
            <DockPanel Margin="0">

                <!-- Search Bar + Hide Factory Folders (top) -->
                <StackPanel DockPanel.Dock="Top"
                            Margin="8"
                            Spacing="6">
                    <TextBox Watermark="Search events..."
                             Text="{Binding SearchKeywords, Mode=TwoWay}"
                             Padding="8,6"
                             Background="#3C3C3C"
                             Foreground="#CCCCCC"
                             BorderBrush="#555555"
                             BorderThickness="1"
                             CornerRadius="4"/>

                    <CheckBox IsChecked="{Binding HideFactoryFolders, Mode=TwoWay}"
                              Content="Hide Factory Folders"
                              Foreground="#9E9E9E"
                              FontSize="12"
                              ToolTip.Tip="If checked, factory folders will be hidden from the hierarchy."
                              Margin="2,0,0,0"/>
                </StackPanel>

                <!-- Refresh Project button (bottom) -->
                <Button DockPanel.Dock="Bottom"
                        Content="Refresh Project"
                        Command="{Binding RefreshProjectCommand}"
                        HorizontalAlignment="Stretch"
                        HorizontalContentAlignment="Center"
                        Margin="8,4,8,8"
                        Padding="8,6"
                        FontSize="12"
                        Foreground="#B0B0B0"
                        Background="#333337"
                        CornerRadius="4"
                        Cursor="Hand"/>

                <!-- Event TreeView (fill remaining space) -->
                <TreeView ItemsSource="{Binding EventTreeNodes}"
                          SelectedItem="{Binding SelectedEventNode, Mode=TwoWay}"
                          Margin="4,0,4,4"
                          Background="Transparent">
                    <!-- Bind TreeViewItem.IsExpanded to the node's IsExpanded
                         property so search results appear fully expanded. -->
                    <TreeView.Styles>
                        <Style Selector="TreeViewItem"
                               x:DataType="vm:EventNodeViewModel">
                            <Setter Property="IsExpanded"
                                    Value="{Binding IsExpanded, Mode=TwoWay}"/>
                        </Style>
                    </TreeView.Styles>
                    <TreeView.ItemTemplate>
                        <!-- Only Folder nodes are expandable — TreeChildren returns
                             the real Children for folders and an empty collection
                             for Containers and Objects. -->
                        <TreeDataTemplate ItemsSource="{Binding TreeChildren}"
                                          x:DataType="vm:EventNodeViewModel">
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <!-- Folder icon (visible when NodeType == Folder) -->
                                <PathIcon Width="14" Height="14"
                                          Foreground="#FFD54F"
                                          IsVisible="{Binding IsFolder}">
                                    <PathIcon.Data>
                                        <PathGeometry Figures="M2,4 L2,14 L14,14 L14,6 L8,6 L6,4 Z"/>
                                    </PathIcon.Data>
                                </PathIcon>
                                <!-- Container icon (visible when NodeType == Container) -->
                                <PathIcon Width="14" Height="14"
                                          Foreground="#64B5F6"
                                          IsVisible="{Binding IsContainer}">
                                    <PathIcon.Data>
                                        <PathGeometry Figures="M2,3 L14,3 L14,13 L2,13 Z M2,6 L14,6"/>
                                    </PathIcon.Data>
                                </PathIcon>
                                <!-- Object / Sound icon (visible when NodeType == Object) -->
                                <PathIcon Width="14" Height="14"
                                          Foreground="#9E9E9E"
                                          IsVisible="{Binding IsObject}">
                                    <PathIcon.Data>
                                        <PathGeometry Figures="M3,2 L13,8 L3,14 Z"/>
                                    </PathIcon.Data>
                                </PathIcon>
                                <!-- Node name -->
                                <TextBlock Text="{Binding Name}"
                                           VerticalAlignment="Center"
                                           Foreground="#DCDCDC"/>
                            </StackPanel>
                        </TreeDataTemplate>
                    </TreeView.ItemTemplate>
                </TreeView>
            </DockPanel>
        </Border>

        <!-- GridSplitter -->
        <GridSplitter Grid.Column="1"
                      Width="4"
                      Background="#333333"
                      ResizeDirection="Columns"/>

        <!-- ─────────────────────────────────────────────────────
             RIGHT PANEL – Event Detail & Controls
             Only visible when an event is selected.
             ───────────────────────────────────────────────────── -->
        <Grid Grid.Column="2"
              RowDefinitions="Auto,Auto,Auto,*,Auto"
              Margin="0"
              IsVisible="{Binding HasSelectedEvent}">

            <!-- ═════════════════════════════════════════════════
                 ROW 0 – Object Header (name + note + related events)
                 ═════════════════════════════════════════════════ -->
            <Border Grid.Row="0"
                    Background="#2D2D30"
                    CornerRadius="6"
                    Margin="12,12,12,6"
                    Padding="16,12">
                <StackPanel Spacing="6">
                    <!-- Object name (large, prominent) -->
                    <TextBlock Text="{Binding SelectedObjectName}"
                               FontSize="22"
                               FontWeight="Bold"
                               Foreground="#E0E0E0"
                               TextTrimming="CharacterEllipsis"/>

                    <!-- Object note (smaller, subdued) -->
                    <TextBlock Text="{Binding SelectedObjectNote}"
                               FontSize="12"
                               Foreground="#8A8A8A"
                               FontStyle="Italic"
                               TextWrapping="Wrap"
                               IsVisible="{Binding SelectedObjectNote.Length}"
                               Margin="0,0,0,4"/>

                    <!-- Related Events section -->
                    <TextBlock Text="Related Events"
                               FontSize="12"
                               FontWeight="SemiBold"
                               Foreground="#9E9E9E"
                               Margin="0,4,0,4"
                               IsVisible="{Binding RelatedEvents.Count}"/>

                    <!-- Related event blocks -->
                    <ItemsControl ItemsSource="{Binding RelatedEvents}"
                                  ItemTemplate="{StaticResource EventBlockTemplate}"
                                  IsVisible="{Binding RelatedEvents.Count}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                    </ItemsControl>

                    <!-- Placeholder when no related events -->
                    <TextBlock Text="No related events found."
                               Foreground="#616161"
                               FontStyle="Italic"
                               FontSize="12"
                               IsVisible="{Binding !RelatedEvents.Count}"
                               Margin="0,2,0,0"/>
                </StackPanel>
            </Border>

            <!-- ═════════════════════════════════════════════════
                 ROW 1 – RTPC Controls
                 ═════════════════════════════════════════════════ -->
            <Border Grid.Row="1"
                    Background="#2D2D30"
                    CornerRadius="6"
                    Margin="12,6"
                    Padding="12">
                <StackPanel>
                    <!-- Section heading -->
                    <TextBlock Text="RTPC Parameters"
                               FontSize="13"
                               FontWeight="SemiBold"
                               Foreground="#9E9E9E"
                               Margin="0,0,0,8"/>

                    <!-- Dynamic RTPC rows -->
                    <ItemsControl ItemsSource="{Binding CurrentEventRTPCs}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="vm:RtpcViewModel">
                                <StackPanel Margin="0,4,0,10">
                                    <!-- Property display name (what this RTPC controls, e.g. "Volume") -->
                                    <TextBlock Text="{Binding PropertyDisplayName}"
                                               FontSize="10"
                                               Foreground="#8A8A8A"
                                               Margin="0,0,0,1"
                                               IsVisible="{Binding HasPropertyDisplayName}"/>
                                    <!-- RTPC parameter name -->
                                    <TextBlock Text="{Binding Name}"
                                               FontSize="13"
                                               Foreground="#BDBDBD"
                                               TextTrimming="CharacterEllipsis"
                                               Margin="0,0,0,6"/>
                                    <!-- Slider + numeric value -->
                                    <Grid ColumnDefinitions="*,64">
                                        <!-- Slider (stretch to fill) -->
                                        <Slider Grid.Column="0"
                                                Minimum="{Binding MinValue}"
                                                Maximum="{Binding MaxValue}"
                                                Value="{Binding CurrentValue, Mode=TwoWay}"
                                                Margin="0,0,8,0"
                                                VerticalAlignment="Center"/>
                                        <!-- Read-only value display (double-click to enter editing mode) -->
                                        <TextBlock Grid.Column="1"
                                                   Text="{Binding CurrentValue, StringFormat={}{0:F1}}"
                                                   Foreground="#E0E0E0"
                                                   VerticalAlignment="Center"
                                                   HorizontalAlignment="Right"
                                                   FontFamily="Consolas"
                                                   FontSize="12"
                                                   Cursor="Hand"
                                                   IsVisible="{Binding !IsEditing}"
                                                   beh:DoubleTapBehavior.Command="{Binding BeginEditCommand}"/>
                                        <!-- Editable value input (visible during editing mode) -->
                                        <TextBox Grid.Column="1"
                                                 Text="{Binding EditText, Mode=TwoWay}"
                                                 IsVisible="{Binding IsEditing}"
                                                 FontFamily="Consolas"
                                                 FontSize="12"
                                                 Foreground="#E0E0E0"
                                                 Background="#3C3C3C"
                                                 BorderBrush="#555555"
                                                 BorderThickness="1"
                                                 CornerRadius="3"
                                                 Padding="4,2"
                                                 HorizontalContentAlignment="Right"
                                                 VerticalAlignment="Center"
                                                 beh:TextBoxCommitBehavior.CommitCommand="{Binding CommitEditCommand}">
                                            <TextBox.KeyBindings>
                                                <KeyBinding Gesture="Enter" Command="{Binding CommitEditCommand}"/>
                                                <KeyBinding Gesture="Escape" Command="{Binding CancelEditCommand}"/>
                                            </TextBox.KeyBindings>
                                        </TextBox>
                                    </Grid>
                                    <!-- Min / Max range labels beneath the slider -->
                                    <Grid ColumnDefinitions="*,64"
                                          Margin="0,4,0,0">
                                        <!-- Left-aligned min value, right-aligned max value under the slider track -->
                                        <Grid Grid.Column="0"
                                              Margin="0,0,8,0">
                                            <TextBlock Text="{Binding MinValue, StringFormat={}{0:F1}}"
                                                       FontSize="10"
                                                       Foreground="#9A9A9A"
                                                       HorizontalAlignment="Left"/>
                                            <TextBlock Text="{Binding MaxValue, StringFormat={}{0:F1}}"
                                                       FontSize="10"
                                                       Foreground="#9A9A9A"
                                                       HorizontalAlignment="Right"/>
                                        </Grid>
                                    </Grid>
                                </StackPanel>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- Placeholder when no RTPCs are present -->
                    <TextBlock Text="No RTPC parameters for this event."
                               Foreground="#616161"
                               FontStyle="Italic"
                               IsVisible="{Binding !CurrentEventRTPCs.Count}"
                               Margin="0,4,0,0"/>
                </StackPanel>
            </Border>

            <!-- ═════════════════════════════════════════════════
                 ROW 2 – Switch Controls
                 Each SwitchGroupViewModel renders as a styled card
                 with a group name label and a ComboBox of options.
                 Multiple groups are handled automatically via
                 ItemsControl + ObservableCollection.
                 ═════════════════════════════════════════════════ -->
            <Border Grid.Row="2"
                    Background="#2D2D30"
                    CornerRadius="6"
                    Margin="12,6"
                    Padding="12">
                <StackPanel>
                    <!-- Section heading -->
                    <TextBlock Text="Switch Groups"
                               FontSize="13"
                               FontWeight="SemiBold"
                               Foreground="#9E9E9E"
                               Margin="0,0,0,8"/>

                    <!-- Dynamic Switch groups – 2-column layout -->
                    <ItemsControl ItemsSource="{Binding CurrentEventSwitches}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <UniformGrid Columns="2"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="vm:SwitchGroupViewModel">
                                <!-- Per-group card: subtle background,
                                     rounded corners, clean spacing -->
                                <Border Background="#333337"
                                        CornerRadius="5"
                                        Padding="10,8"
                                        Margin="4,4">
                                    <StackPanel Spacing="6">
                                        <!-- Group name label -->
                                        <TextBlock Text="{Binding GroupName}"
                                                   Foreground="#BDBDBD"
                                                   FontSize="12"
                                                   FontWeight="SemiBold"/>

                                        <!-- Switch state selector (ComboBox)
                                             • ItemsSource → AvailableSwitches (SwitchOptionModel collection)
                                             • ItemTemplate → displays SwitchOptionModel.Name
                                             • SelectedItem → TwoWay to SelectedSwitch
                                             • To later call WAAPI SetSwitch, use:
                                               switchGroupVm.GetSelectedSwitchId()
                                               from the service layer. -->
                                        <ComboBox ItemsSource="{Binding AvailableSwitches}"
                                                  SelectedItem="{Binding SelectedSwitch, Mode=TwoWay}"
                                                  ItemTemplate="{StaticResource SwitchOptionTemplate}"
                                                  HorizontalAlignment="Stretch"
                                                  Background="#3C3C3C"
                                                  Foreground="#DCDCDC"
                                                  BorderBrush="#555555"
                                                  CornerRadius="4"
                                                  Padding="6,4"/>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- Placeholder when no Switches are present -->
                    <TextBlock Text="No switch groups for this event."
                               Foreground="#616161"
                               FontStyle="Italic"
                               IsVisible="{Binding !CurrentEventSwitches.Count}"
                               Margin="0,4,0,0"/>
                </StackPanel>
            </Border>

            <!-- ═════════════════════════════════════════════════
                 ROW 3 – Flexible spacer (star-sized, pushes status bar down)
                 ═════════════════════════════════════════════════ -->

            <!-- ═════════════════════════════════════════════════
                 ROW 4 – Status Bar (subtle text, no colored fill)
                 ═════════════════════════════════════════════════ -->
            <Border Grid.Row="4"
                    Padding="12,6"
                    Margin="12,0,12,8">
                <TextBlock Text="{Binding StatusMessage}"
                           Foreground="#757575"
                           FontSize="12"
                           VerticalAlignment="Center"/>
            </Border>
        </Grid>

        <!-- Placeholder when nothing is selected -->
        <StackPanel Grid.Column="2"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    IsVisible="{Binding !HasSelectedEvent}">
            <TextBlock Text="Select an event from the tree"
                       FontSize="16"
                       Foreground="#616161"
                       HorizontalAlignment="Center"/>
            <TextBlock Text="to view its controls"
                       FontSize="14"
                       Foreground="#4A4A4A"
                       HorizontalAlignment="Center"
                       Margin="0,4,0,0"/>
        </StackPanel>
    </Grid>
</Window>
